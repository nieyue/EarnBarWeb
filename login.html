<!doctype html>
<html style="height: 100%;margin: 0;border: 0;padding: 0;">

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<script type="text/javascript" src="js/jquery-1.8.1.min.js" ></script>
		<link href="css/mui.min.css" rel="stylesheet" />
		<link href="css/mui.css" rel="stylesheet" />
		<link rel="stylesheet" href="css/home.css" />
		<script type="text/javascript" src="js/spin.min.js" ></script>
		<script type="text/javascript" src="js/home.js" ></script>
		<style > 
		*{
			margin: 0;
			padding: 0;
		};

		</style>
    
	</head>

	<body style="position:static;top:0;left:0;background-color:#fff;height: 100%;margin: 0;padding: 0;width: 100%; 
	<!--  background-image: url(img/login.png); 
			 background-size: 100% 100%; -->
		">
 		
		<div id="loginDivId" style="display:block;" >

			<input type="text" id="loginPhone" style="border:1px solid #ececec;position: static;left: 0;margin-left:10%;margin-top:100px;top: 0; width: 80%;height:auto;z-index:99999;" placeholder="手机号"/>
			<input type="password" id="loginPassword" style="border:1px solid #ececec;position: static;left: 0;top: 0; margin-left:10%;margin-top:0;width: 80%;height:auto;" placeholder="密码"/>
			<div style="position: static;left: 0;top: 0;margin-left:10%;margin-top:0;width: 80%;">
			<input type="text" id="loginCode" style="border:1px solid #ececec; width: 49%;height:40px;" placeholder="验证码"/>
			 <img alt=""  src="" id="loginCodeBtn" style="border:1px solid #ececec; width: 49%;height:40px;vertical-align:middle;" >
			</div>

		<a onclick="loginSubmit()" type="button" style="display:inline-block;position: static;left: 0;top:0; margin-left:10%;width: 80%;height:auto;background:green;color: #FFFFFF;text-align:center;">
			<!-- <img style="height:3rem;vertical-align:bottom" src="img/weixinicon.jpg"> -->
			<span style="display:inline-block;height:2rem;vertical-align:bottom;line-height:2rem;font-size:1.5rem;">登录</span>
		</a>
		</div>

		<div id="registerDivId" style="display:none;">

			<input type="text" id="registerPhone" style="border:1px solid #ececec;position: static;left: 0;top: 0; margin-left:10%;margin-top:100px;width: 80%;height:auto;z-index:99999;" placeholder="手机号"/>
			<input type="password" id="registerPassword" style="margin-left:10%;border:1px solid #ececec;position: static;left: 0;top: 0; width: 80%;height:auto;" placeholder="密码"/>
			<div style="margin-left:10%;">
				
			<input type="text" id="registerCode" style="border:1px solid #ececec;position: static;left: 0;top:0; width: 40%;height:40px;" placeholder="验证码"/>
			<input type="button" style="border:1px solid #ececec;position: static;left: 0;top: 0; width: 40%;height:40px;" id="registerCodeBtn" value="获取验证码"/>
			</div>
		
		<a onclick="registerSubmit()" type="button" style="display:inline-block;margin-left:10%;position: static;left: 0;top: 0; width: 80%;height:auto;background:blue;color: #FFFFFF;text-align:center;">
			<!-- <img style="height:3rem;vertical-align:bottom" src="img/weixinicon.jpg"> -->
			<span style="display:inline-block;height:2rem;vertical-align:bottom;line-height:2rem;font-size:1.5rem;">注册</span>
		</a>
		</div>


		<div id="lodingdiv" class="centerdiv" style="text-align: center;display: none;">
    	</div>
<div style="width: 100%;height: 40px;margin-top:50px;background: #FFFFFF;">
		    	<li id="loginBtnId" onclick="loginBtn()" style="line-height: 40px;float: left;width: 50%;text-align: center;color: #b033b1;font-size: 15px;border-right: 1px solid #ededed;">登录</li>
		    	<li id="registerBtnId" onclick="registerBtn()" style="line-height: 40px;float: left;width: 50%;text-align: center;font-size: 15px;border-left: 1px solid #ededed;">注册</li>
		  </div>
 	<script src="js/mui.min.js"></script>
		<script src="../js/mui.zoom.js">    </script> 
	    <script src="../js/mui.previewimage.js"></script> 
	    <script src="../js/tools.js" ></script>
		<script src="http://pv.sohu.com/cityjson?ie=utf-8"></script>

		<script type="text/javascript">
//			var info='{"sex":1,"nickname":"lala","unionid":"oU5Yyt2FXvE6rjG-FdDJltKhJNsg","privilege":[],"province":"","openid":"oRrdQt7cdv12eGLSdXvs3PQ2xxeE","language":"zh_CN","headimgurl":"http://wx.qlogo.cn/mmopen/R9SHK9xib1plWsLqtlXsNlWsrqk51P1AZ9SeKA8bTMszfQdMbiaKrAaay0YcKAkwTVajkdxSHDa0vLSa9KCPRZxqWNm17MQ8RY/0","country":"中国","city":""}';
//			$.get("http://192.168.7.37/acount/wxlogin",
//			{
//				wxinfo:info
//			},function(data){
//				
//				console.log(data.code);
//				console.log(data.msg);
//			});
				//切换登录 注册
				var loginBtnId=document.querySelector("#loginBtnId");
				var registerBtnId=document.querySelector("#registerBtnId");
				var loginDivId=document.querySelector("#loginDivId");
				var registerDivId=document.querySelector("#registerDivId");
			function loginBtn(){
				loginBtnId.style.color='#b033b1';
				registerBtnId.style.color='#000';
				loginDivId.style.display='block';
				registerDivId.style.display='none';

			}
			function registerBtn(){
				loginBtnId.style.color='#000';
				registerBtnId.style.color='#b033b1';
				loginDivId.style.display='none';
				registerDivId.style.display='block';
			}
				//发送手机验证码
				var registerCodeBtn=document.querySelector("#registerCodeBtn");
				var registerPhone=document.querySelector("#registerPhone");
				var codetime=60;
				registerCodeBtn.addEventListener("click",function(){
					if(!/(^1[0-9]{10}$)/.test(registerPhone.value)){
					mui.toast("手机号错误");
					return ;
				}
				mui.ajax(localStorage.getItem("hostUrl")+'/acount/validCode?d='+new Date().getTime(),{
				data:{
				adminName:registerPhone.value
				},
				dataType:'json',//服务器返回json格式数据
				type:'get',//HTTP请求类型
				timeout:10000,//超时时间设置为10秒；
				xhrFields: {withCredentials: true},	 
				//headers:{'Content-Type':'application/json'},	              
				success:function(data){
					//服务器返回响应，根据响应结果，分析是否登录成功；
					if(data.code==200){
						mui.toast("发送成功");
						registerCodeBtn.disabled=true;	
					registerCodeBtn.value="还剩"+codetime+"秒";
					codetime--;
					//定时器
					var setIntervalCode=setInterval(function(){
					registerCodeBtn.value="还剩"+codetime+"秒";
						if(codetime<=0){
							clearInterval(setIntervalCode);
							codetime=60;
							registerCodeBtn.disabled=false;	
							registerCodeBtn.value="获取验证码";
							return;
						}							
					codetime--;
					},1000);
					}else{
						mui.toast("发送失败，请检查网络");
					}
					closeloding();
					
				},
				error:function(xhr,type,errorThrown){
					//异常处理；
					closeloding();
					mui.toast("发送失败，请检查网络")
					
				}
			});

					
				},false);
			//点击获取登陆验证码
			document.querySelector("#loginCodeBtn").addEventListener("click",function(){
			getVerificationCode();
			},false);
			//获取登陆验证码
			//getVerificationCode();
		
			document.querySelector("#loginCodeBtn").setAttribute("src",localStorage.getItem("hostUrl")+'/getVerificationCode?d='+new Date().getTime());

			function getVerificationCode(){
				document.querySelector("#loginCodeBtn").setAttribute("src",localStorage.getItem("hostUrl")+'/getVerificationCode?d='+new Date().getTime());
				return;
			}
			//登录
			function loginSubmit(){
				var loginPhone=document.querySelector("#loginPhone");
				var loginPassword=document.querySelector("#loginPassword");
				var loginCode=document.querySelector("#loginCode");
				if(!/(^1[0-9]{10}$)/.test(loginPhone.value)){
					mui.toast("手机号错误");
					return ;
				}
				if(loginPassword.value.length<6||loginPassword.value.length>16){
					mui.toast("密码长度6-16");
					return ;
				}
				if(loginCode.value.length!=4){
					mui.toast("验证码长度4");
					return ;
				}
				showloding("正在登陆");
			mui.ajax(localStorage.getItem("hostUrl")+'/acount/weblogin?d='+new Date().getTime(),{
				data:{
					adminName:loginPhone.value,
					password:loginPassword.value,
					random:loginCode.value
				},
				dataType:'json',//服务器返回json格式数据
				type:'get',//HTTP请求类型
				timeout:10000,//超时时间设置为10秒；
				xhrFields: {withCredentials: true},	 
				//headers:{'Content-Type':'application/json'},	              
				success:function(data){
					//服务器返回响应，根据响应结果，分析是否登录成功；
					if(data.code==200){
						mui.toast("登陆成功");
						var status = data.list[0].status;
						var acountId = data.list[0].acountId;
						if(status==0||status==2){
							console.log(JSON.stringify(data.list[0]));
		//					localStorage.setItem("token",JSON.data.list[1].token);
							localStorage.setItem("user",JSON.stringify(data.list[0]));
							localStorage.setItem("acountId",acountId);
							localStorage.setItem("username",data.list[0].nickname||data.list[0].phone);
							localStorage.setItem("headimg",data.list[0].icon||'img/touxiang.jpg');
							localStorage.setItem("openid",data.list[0].openid);
							//localStorage.setItem("weixininfo",JSON.stringify(data.list[0]));
							location.replace("index.html");
					}else if(status==1){
						mui.alert("您的账号已被锁定，已被禁止登陆，如有疑问，请及时联系客服");
						localStorage.removeItem("user");
						localStorage.removeItem("acountId");
						localStorage.removeItem("username");
						localStorage.removeItem("headimg");
						
					}
						
					}else{
						
						mui.toast("登录失败，请检查网络");
					}
					closeloding();
					
				},
				error:function(xhr,type,errorThrown){
					//异常处理；
					closeloding();
					mui.toast("登录失败，请检查网络")
					console.log(type);
				}
			});

			}
			//注册
			function registerSubmit(){
			var registerPhone=document.querySelector("#registerPhone");
				var registerPassword=document.querySelector("#registerPassword");
				var registerCode=document.querySelector("#registerCode");
				if(!/(^1[0-9]{10}$)/.test(registerPhone.value)){
					mui.toast("手机号错误");
					return ;
				}
				if(registerPassword.value.length<6||registerPassword.value.length>16){
					mui.toast("密码长度6-16");
					return ;
				}
				if(registerCode.value.length!=4){
					mui.toast("验证码长度4");
					return ;
				}
				showloding("正在注册");
				mui.ajax(localStorage.getItem("hostUrl")+'/acount/webregister',{
				data:{
					adminName:registerPhone.value,
					password:registerPassword.value,
					appVersion:window.navigator.appVersion,
					validCode:registerCode.value
				},
				dataType:'json',//服务器返回json格式数据
				type:'post',//HTTP请求类型
				timeout:10000,//超时时间设置为10秒；
				//headers:{'Content-Type':'application/json'},	  
				xhrFields: {withCredentials: true},	             
				success:function(data){
					//服务器返回响应，根据响应结果，分析是否登录成功；
					if(data.code==200){
					var acountId = data.list[0].acountId;
					console.log(acountId);
					localStorage.setItem("user",JSON.stringify(data.list[0]));
					localStorage.setItem("acountId",acountId);
					localStorage.setItem("username",data.list[0].nickname||data.list[0].phone);
					localStorage.setItem("headimg",data.list[0].headimgurl||'img/touxiang.jpg');
					//localStorage.setItem("openid",data.list[0].openid);
					mui.toast("注册成功");
					location.replace("index.html");
					closeloding();
				
					}else{
						closeloding();
						
						mui.toast("登录失败，请检查网络");
					}
					
				},
				error:function(xhr,type,errorThrown){
					//异常处理；
					closeloding();
					mui.toast("登录失败，请检查网络")
					console.log(type);
				}
			});

			}
			mui.init({
				beforeback: function(){
			        //获得列表界面的webview
			        var i = plus.webview.getWebviewById("homecontent");
			        console.log("页面返回"+i);
			        if(i){
			            //触发列表界面的自定义事件（refresh）,从而进行数据刷新
			            i.evalJS("getinfo()");
			        }
			        return true;
			    }
			});
			var auths;
			mui.plusReady(function() {   
			plus.screen.lockOrientation("portrait-primary");
            plus.oauth.getServices(function(services) { 
                auths = services; 
            }, function(e) { 
                alert("获取登录服务列表失败：" + e.message + " - " + e.code); 
            }); 
        });
			
			function gohome(){
				document.getElementById("lodingdiv").style.display = "";
				showloding("正在登陆");
				authLogin('weixin');
			}
			
			
			function authLogin(type) { 
            var s; 
            for (var i = 0; i < auths.length; i++) { 
                if (auths[i].id == type) { 
                    s = auths[i]; 
                    break; 
                } 
            } 
            if (!s.authResult) { 
                s.login(function(e) { 
                    mui.toast("登录认证成功！"); 
                    authUserInfo(type); 
                }, function(e) { 
                    mui.toast("登录认证失败！"); 
					closeloding();
                }); 
            } else { 
                
				authUserInfo(type); 
            } 
        } 
        //注销 
        function authLogout() { 
            for (var i in auths) { 
                var s = auths[i]; 
                if (s.authResult) { 
                    s.logout(function(e) { 
                        console.log("注销登录认证成功！"); 
                    }, function(e) { 
                        console.log("注销登录认证失败！"); 
                    }); 
                } 
            } 
        } 
		var jsonObj;
        // 微信登录认证信息 
        function authUserInfo(type) { 
            var s; 
            for (var i = 0; i < auths.length; i++) { 
                if (auths[i].id == type) { 
                    s = auths[i]; 
                    break; 
                } 
            } 
            if (!s.authResult) { 
				closeloding();
                mui.toast("未授权登录！"); 
            } else { 
                s.getUserInfo(function(e) { 
                    var josnStr = JSON.stringify(s.userInfo); 
                     jsonObj = s.userInfo; 
					
                    console.log("获取用户信息成功：" + josnStr); 
					postinfo(josnStr);
                    

                }, function(e) {
					closeloding(); 
                    alert("获取用户信息失败：" + e.message + " - " + e.code); 
                }); 
            } 
        }

		function postinfo(info){
			console.log("进行请求");
			console.log("设备信息"+ navigator.appVersion+"ip地址="+window.navigator.appVersion);
			console.log(info);
				
			mui.ajax(localStorage.getItem("hostUrl")+'/acount/wxlogin',{
				data:{
					wxinfo:info.toString(),
					appVersion:window.navigator.appVersion
				},
				dataType:'json',//服务器返回json格式数据
				type:'post',//HTTP请求类型
				timeout:10000,//超时时间设置为10秒；
				//headers:{'Content-Type':'application/json'},	  
				xhrFields: {withCredentials: true},	             
				success:function(data){
					//服务器返回响应，根据响应结果，分析是否登录成功；
					console.log(data.code);
					console.log(data.msg);
					if(data.code==200){
					var acountId = data.list[0].acountId;
					console.log(acountId);
					localStorage.setItem("user",JSON.stringify(data.list[0]));
					localStorage.setItem("acountId",acountId);
					localStorage.setItem("username",jsonObj.nickname);
					localStorage.setItem("headimg",jsonObj.headimgurl);
					localStorage.setItem("openid",jsonObj.openid);
					
					closeloding();
					mui.back();
					}else{
						closeloding();
						mui.back();
						mui.toast("登录失败，请检查网络");
					}
					
				},
				error:function(xhr,type,errorThrown){
					//异常处理；
					closeloding();
					mui.toast("登录失败，请检查网络")
					console.log(type);
				}
			});
			

		}
//		
		</script>
	</body>

</html>